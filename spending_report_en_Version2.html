<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spending Report (Weekly & Monthly)</title>
  <style>
    :root{
      --bg:#0f172a;
      --panel:#0b1229;
      --card:#111a38;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --brand:#7c3aed;
      --brand-2:#22c55e;
      --accent:#38bdf8;
      --danger:#ef4444;
      --warning:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 80% -100px, rgba(124,58,237,.25), transparent 60%),
                 radial-gradient(900px 600px at -20% 20%, rgba(56,189,248,.18), transparent 60%), var(--bg);
         color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;}
    .container{max-width:1100px;margin:32px auto;padding:0 16px}
    .header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-size: clamp(1.4rem, 1.1rem + 1.5vw, 2rem); font-weight:800; letter-spacing:.3px; display:flex; align-items:center; gap:10px}
    .title .badge{background:linear-gradient(135deg, var(--brand), var(--accent)); padding:4px 10px; border-radius:999px; font-size:.8rem; font-weight:700}

    .toolbar{display:flex;flex-wrap:wrap; gap:10px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.08); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .controls{display:grid; grid-template-columns: repeat(5, minmax(160px, 1fr)); gap:12px}
    label{font-size:.82rem; color:var(--muted); display:block; margin-bottom:6px}
    input, select, button{width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1); background:#0b1229; color:var(--text)}
    input::placeholder{color:#94a3b8}
    button{cursor:pointer; border:none; background:linear-gradient(135deg, rgba(124,58,237,.95), rgba(56,189,248,.95)); font-weight:700}
    button.secondary{background:#0b1229; border:1px solid rgba(255,255,255,.12)}
    button.danger{background: linear-gradient(135deg, var(--danger), #f97316)}

    .table-wrap{margin-top:16px}
    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    thead th{font-size:.8rem; font-weight:700; text-transform:uppercase; letter-spacing:.06em; color:#a6b0c3; padding:6px 10px}
    tbody tr{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08)}
    tbody tr td{padding:8px}
    tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    tbody input, tbody select{width:100%; background:#0b1229; border:1px solid rgba(255,255,255,.09)}

    .summary{display:grid; grid-template-columns: 1.1fr 1.2fr; gap:16px; margin-top:18px}
    .sum-item{display:flex; align-items:center; gap:14px}
    .sum-item .dot{width:10px;height:10px;border-radius:50%}
    .stats{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .kpi{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px}
    .kpi h3{margin:0; font-size:.9rem; color:#a6b0c3; font-weight:700}
    .kpi p{margin:6px 0 0 0; font-size:1.4rem; font-weight:800}

    .progress{height:14px; background:#0b1229; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.12)}
    .progress > div{height:100%; width:0%; background:linear-gradient(90deg, var(--brand), var(--warning) 60%, var(--danger)); transition:width .3s ease}

    .donut{--p:0; width:140px; height:140px; border-radius:50%; background:conic-gradient(var(--brand) 0 var(--p), rgba(255,255,255,.08) var(--p) 360deg); position:relative}
    .donut::after{content:""; position:absolute; inset:12px; background:var(--panel); border-radius:50%; border:1px solid rgba(255,255,255,.06)}
    .donut-label{position:absolute; inset:0; display:grid; place-content:center; font-weight:800}

    .tips{font-size:.86rem; color:#a6b0c3}

    .footer{margin-top:28px; font-size:.8rem; color:#95a1b9; display:flex; justify-content:space-between; align-items:center}

    @media (max-width: 900px){
      .controls{grid-template-columns: 1fr 1fr}
      .summary{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title"> Alan Spending Ret <span class="badge">v2.0</span></div>
      <div class="toolbar" role="toolbar" aria-label="Actions">
        <button id="addRowBtn">+ Add Entry</button>
        <button id="exportBtn" class="secondary">‚¨áÔ∏è Export CSV</button>
        <label for="importCsv" style="display:flex;align-items:center;gap:8px" class="secondary">
          <input id="importCsv" type="file" accept=".csv" style="display:none" />
          <button id="importBtn" class="secondary">‚¨ÜÔ∏è Import CSV</button>
        </label>
        <button id="clearBtn" class="danger">üóë Clear Period</button>
      </div>
    </div>

    <section class="card controls" aria-label="Period and Budget Controls">
      <div>
        <label for="type">Report Type</label>
        <select id="type">
          <option value="week">Weekly</option>
          <option value="month">Monthly</option>
        </select>
      </div>
      <div>
        <label for="periodStart">Start Date</label>
        <input type="date" id="periodStart" />
      </div>
      <div>
        <label for="currency">Currency</label>
        <select id="currency">
          <option value="USD" selected>USD $</option>
          <option value="MXN">MXN $</option>
          <option value="EUR">EUR ‚Ç¨</option>
        </select>
      </div>
      <div>
        <label for="budget">Budget</label>
        <input type="number" id="budget" min="0" step="0.01" placeholder="e.g. 80" />
      </div>
      <div>
        <label>&nbsp;</label>
        <div class="sum-item">
          <div style="flex:1">
            <div class="progress" title="Spending Progress">
              <div id="progressBar"></div>
            </div>
          </div>
          <div style="width:80px;text-align:right"><span id="progressPct">0%</span></div>
        </div>
      </div>
    </section>

    <section class="table-wrap" aria-label="Spending Table">
      <table id="spendTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Category</th>
            <th>Method</th>
            <th>Amount</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <section class="summary">
      <div class="card stats">
        <div class="kpi">
          <h3>Total Spent</h3>
          <p id="totalSpent">$0.00</p>
        </div>
        <div class="kpi">
          <h3>Remaining</h3>
          <p id="remaining">$0.00</p>
        </div>
        <div class="kpi">
          <h3>Average/Day</h3>
          <p id="avgPerDay">$0.00</p>
        </div>
        <div class="kpi">
          <h3>Total Entries</h3>
          <p id="entriesCount">0</p>
        </div>
      </div>
      <div class="card" style="display:flex; align-items:center; gap:16px; justify-content:space-between">
        <div style="display:flex; align-items:center; gap:14px">
          <div class="donut" id="donut" style="--p:0deg">
            <div class="donut-label" id="donutLabel">0%</div>
          </div>
          <div>
            <div class="sum-item"><span class="dot" style="background:var(--brand)"></span> <span>Spent vs Budget</span></div>
            <p class="tips">The ring shows the % of your budget used. Stay below 80% for good control ‚úÖ</p>
          </div>
        </div>
        <div>
          <label for="quickNote">Quick Note</label>
          <input id="quickNote" placeholder="E.g. This month save on snacks" />
        </div>
      </div>
    </section>

    <div class="footer">
      <span>Made by Alan/Ai.</span>
      <span id="periodLabel"></span>
    </div>
  </div>

  <template id="rowTemplate">
    <tr>
      <td><select class="day"></select></td>
      <td><input class="desc" placeholder="E.g. Sandwich" /></td>
      <td>
        <select class="cat">
          <option value="Food">Food</option>
          <option value="Transport">Transport</option>
          <option value="School">School</option>
          <option value="Entertainment">Entertainment</option>
          <option value="Health">Health</option>
          <option value="Other">Other</option>
        </select>
      </td>
      <td>
        <select class="pay">
          <option>Cash</option>
          <option>Card</option>
          <option>Transfer</option>
        </select>
      </td>
      <td><input class="amt" type="number" step="0.01" min="0" placeholder="0.00" /></td>
      <td style="width:40px"><button class="secondary" data-action="delete" title="Delete row">‚úñ</button></td>
    </tr>
  </template>

  <script>
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
    const fmt = (n, cur) => new Intl.NumberFormat('en-US', { style:'currency', currency: cur }).format(Number(n||0));

    const state = {
      type: 'week',
      periodStart: null,
      currency: 'USD',
      budget: 0,
      entries: [],
      note: ''
    };

    function startOfWeek(d){
      const date = new Date(d);
      const day = date.getDay(); // 0 Sun - 6 Sat
      const diff = date.getDate() - day + 1; // Monday as start
      const monday = new Date(date.setDate(diff));
      monday.setHours(0,0,0,0);
      return monday;
    }
    function startOfMonth(d){
      const date = new Date(d);
      return new Date(date.getFullYear(), date.getMonth(), 1);
    }

    function periodKey(date, type){
      if(type === 'month'){
        const d = startOfMonth(date);
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        return `month-${y}-${m}`;
      } else {
        const d = startOfWeek(date);
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const da = String(d.getDate()).padStart(2,'0');
        return `week-${y}-${m}-${da}`;
      }
    }

    function save(){
      const key = periodKey(state.periodStart || new Date(), state.type);
      const payload = { ...state, entries: getEntriesFromDOM() };
      localStorage.setItem(key, JSON.stringify(payload));
    }

    function load(date, type){
      const key = periodKey(date, type);
      const raw = localStorage.getItem(key);
      if(raw){
        const data = JSON.parse(raw);
        state.periodStart = new Date(data.periodStart || date);
        state.currency = data.currency || 'USD';
        state.budget = Number(data.budget||0);
        state.entries = data.entries || [];
        state.note = data.note || '';
        state.type = data.type || type;
      }else{
        state.periodStart = type === 'month' ? startOfMonth(date) : startOfWeek(date);
        state.currency = 'USD';
        state.budget = 0;
        state.entries = [];
        state.note = '';
        state.type = type;
      }
      renderAll();
    }

    function renderAll(){
      // Controls
      $('#type').value = state.type;
      $('#periodStart').value = toInputDate(state.periodStart);
      $('#currency').value = state.currency;
      $('#budget').value = state.budget || '';
      $('#quickNote').value = state.note || '';

      // Period label
      let label;
      if(state.type === 'month') {
        const start = new Date(state.periodStart);
        const end = new Date(start.getFullYear(), start.getMonth()+1, 0);
        label = `Month: ${start.toLocaleDateString()} ‚Äì ${end.toLocaleDateString()}`;
      } else {
        const start = new Date(state.periodStart);
        const end = new Date(start); end.setDate(end.getDate()+6);
        label = `Week: ${start.toLocaleDateString()} ‚Äì ${end.toLocaleDateString()}`;
      }
      $('#periodLabel').textContent = label;

      // Rows
      const tbody = $('#tbody');
      tbody.innerHTML = '';
      if(state.entries.length === 0){ addRow(); }
      else{
        for(const e of state.entries){ addRow(e); }
      }
      recalc();
    }

    function toInputDate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    function dayOptions(){
      if(state.type === 'month') {
        const start = startOfMonth(state.periodStart);
        const end = new Date(start.getFullYear(), start.getMonth()+1, 0);
        const days = (end.getDate() - start.getDate()) + 1;
        return Array.from({length: days}, (_,i)=>{
          const d = new Date(start); d.setDate(d.getDate()+i);
          return { label: d.toLocaleDateString(undefined,{ weekday:'short', month:'short', day:'numeric'}), value: toInputDate(d)};
        });
      } else {
        const start = startOfWeek(state.periodStart);
        return Array.from({length:7}, (_,i)=>{
          const d = new Date(start); d.setDate(d.getDate()+i);
          return { label: d.toLocaleDateString(undefined,{ weekday:'short', month:'short', day:'numeric'}), value: toInputDate(d)};
        });
      }
    }

    function addRow(data={}){
      const tpl = $('#rowTemplate').content.cloneNode(true);
      const tr = tpl.querySelector('tr');
      const daySel = tpl.querySelector('.day');
      const desc = tpl.querySelector('.desc');
      const cat = tpl.querySelector('.cat');
      const pay = tpl.querySelector('.pay');
      const amt = tpl.querySelector('.amt');

      // Populate day options
      daySel.innerHTML = '';
      for(const opt of dayOptions()){
        const o = document.createElement('option');
        o.value = opt.value; o.textContent = opt.label; daySel.appendChild(o);
      }

      // Set values if provided
      if(data.day) daySel.value = data.day;
      if(data.desc) desc.value = data.desc;
      if(data.cat) cat.value = data.cat;
      if(data.pay) pay.value = data.pay;
      if(data.amt!=null) amt.value = data.amt;

      // Events
      tr.addEventListener('input', ()=>{ recalc(); save(); });
      tr.querySelector('[data-action="delete"]').addEventListener('click', ()=>{ tr.remove(); recalc(); save(); });

      $('#tbody').appendChild(tr);
    }

    function getEntriesFromDOM(){
      return $$('#tbody tr').map(tr => ({
        day: tr.querySelector('.day').value,
        desc: tr.querySelector('.desc').value.trim(),
        cat: tr.querySelector('.cat').value,
        pay: tr.querySelector('.pay').value,
        amt: Number(tr.querySelector('.amt').value || 0)
      }));
    }

    function recalc(){
      const rows = getEntriesFromDOM();
      const total = rows.reduce((s,r)=> s + (Number(r.amt)||0), 0);
      const budget = Number($('#budget').value || 0);

      // KPIs
      $('#totalSpent').textContent = fmt(total, state.currency);
      $('#entriesCount').textContent = rows.length;

      // Avg per day (only days with entries count)
      const daysUsed = new Set(rows.filter(r=>r.amt>0).map(r=>r.day)).size || 1;
      $('#avgPerDay').textContent = fmt(total / daysUsed, state.currency);

      // Remaining
      const remaining = Math.max(0, budget - total);
      $('#remaining').textContent = fmt(remaining, state.currency);

      // Progress bar & donut
      const pct = budget>0 ? Math.min(100, Math.round((total / budget)*100)) : 0;
      $('#progressBar').style.width = pct + '%';
      $('#progressPct').textContent = pct + '%';
      const deg = Math.round((pct/100)*360);
      $('#donut').style.setProperty('--p', deg + 'deg');
      $('#donutLabel').textContent = pct + '%';

      // Visual warnings
      const pb = $('#progressBar');
      pb.style.background = pct < 80 ? `linear-gradient(90deg, var(--brand), var(--brand-2))` : pct < 100 ? `linear-gradient(90deg, var(--warning), #f59e0b)` : `linear-gradient(90deg, var(--danger), #ef4444)`;
    }

    // Export CSV
    function exportCSV(){
      const rows = getEntriesFromDOM();
      const header = ['date','description','category','method','amount'];
      const data = [header.join(','), ...rows.map(r => [r.day, esc(r.desc), r.cat, r.pay, r.amt].join(','))].join('\n');
      const blob = new Blob([data], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${periodKey(state.periodStart, state.type)}.csv`; a.click();
      URL.revokeObjectURL(url);
    }

    function esc(text){
      const t = String(text||'');
      if(t.includes(',') || t.includes('"')){
        return '"' + t.replace(/"/g,'""') + '"';
      }
      return t;
    }

    // Import CSV
    function importCSV(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        const text = e.target.result;
        const lines = text.split(/\r?\n/).filter(Boolean);
        const body = lines.slice(1).map(line=>{
          const cols = parseCSV(line);
          return { day: cols[0], desc: cols[1], cat: cols[2], pay: cols[3], amt: Number(cols[4]||0) };
        });
        state.entries = body; renderAll(); save();
      };
      reader.readAsText(file);
    }

    function parseCSV(line){
      const result = [];
      let cur = ''; let inQ = false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch==='"'){
          if(inQ && line[i+1]==='"'){ cur+='"'; i++; }
          else inQ = !inQ;
        } else if(ch===',' && !inQ){ result.push(cur); cur=''; }
        else cur+=ch;
      }
      result.push(cur);
      return result;
    }

    // Events wiring
    $('#addRowBtn').addEventListener('click', ()=>{ addRow(); save(); });
    $('#exportBtn').addEventListener('click', exportCSV);
    $('#importBtn').addEventListener('click', ()=> $('#importCsv').click());
    $('#importCsv').addEventListener('change', (e)=>{
      const file = e.target.files[0]; if(file) importCSV(file);
      e.target.value='';
    });

    $('#clearBtn').addEventListener('click', ()=>{
      if(confirm('Are you sure you want to clear all entries for this period?')){
        state.entries = []; renderAll(); save();
      }
    });

    $('#type').addEventListener('change', (e)=>{
      state.type = e.target.value;
      if(state.type === 'month') {
        state.periodStart = startOfMonth(state.periodStart || new Date());
      } else {
        state.periodStart = startOfWeek(state.periodStart || new Date());
      }
      load(state.periodStart, state.type);
    });
    $('#periodStart').addEventListener('change', (e)=>{
      state.periodStart = new Date(e.target.value);
      load(state.periodStart, state.type);
    });
    $('#currency').addEventListener('change', (e)=>{ state.currency = e.target.value; recalc(); save(); });
    $('#budget').addEventListener('input', ()=>{ recalc(); save(); });
    $('#quickNote').addEventListener('input', (e)=>{ state.note = e.target.value; save(); });

    // Init
    (function init(){
      const now = new Date();
      state.type = 'week';
      state.periodStart = startOfWeek(now);
      load(state.periodStart, state.type);
    })();
  </script>
</body>
</html>